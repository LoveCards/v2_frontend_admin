name: build-releases

on:
    push:
        tags:
            - "v*.*.*" # æ¨é€å½¢å¦‚ v1.2.3 çš„ tag æ—¶è§¦å‘
    workflow_dispatch: # ä¹Ÿå¯æ‰‹åŠ¨è§¦å‘

jobs:
    Build_Release:
        runs-on: ubuntu-latest

        steps:
            # 1. æ‹‰å–å‰ç«¯æºç ï¼ˆå«å®Œæ•´å†å²ï¼Œæ–¹ä¾¿ git logï¼‰
            - name: ğŸ¡æ‹‰å–ä»£ç 
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # 2. æå–çº¯ç‰ˆæœ¬å·ï¼ˆæŠŠ refs/tags/v1.2.3 â†’ 1.2.3ï¼‰
            # - name: âœï¸æå–æ ‡ç­¾åç§°
            #   id: extract_tag
            #   run: echo "tag=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            # 3. å®‰è£… Node å¹¶ç¼“å­˜ npm ä¾èµ–
            - name: ğŸ”§è®¾ç½® Node ç¯å¢ƒ
              uses: actions/setup-node@v4
              with:
                  node-version: 20 # æŒ‰éœ€æ”¹ç‰ˆæœ¬
                  cache: npm

            # 4. å®‰è£…ä¾èµ– & æ„å»º
            - name: ğŸ“¦å®‰è£…ä¾èµ–
              run: npm ci

              # æ‰“åŒ…å¹¶æ’å…¥å˜é‡
            - name: ğŸ—ï¸Nuxt3 æ‰“åŒ…
              run: |
                  export NUXT_PUBLIC_GIT_SHA="${GITHUB_SHA:0:7}"
                  npm run generate

            # 5. æŠŠæ„å»ºç»“æœå‹ç¼©
            - name: ğŸ—œï¸å‹ç¼©ä¸º zip
              run: |
                  mv ./dist ./admin
                  zip -r admin.zip ./admin

            # 6. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ é™„ä»¶
            - name: ğŸ…åˆ›å»ºå‘å¸ƒå¹¶ä¸Šä¼ å‹ç¼©åŒ…
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ GITHUB.REF_name }}
                  name: ${{ GITHUB.REF_name }}
                  body_path: RELEASE.txt
                  draft: false
                  prerelease: true
                  files: |
                      admin.zip
                      LICENSE
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
